# furneaux

This tool backs up one or more datasets from one pool to another and manages incremental sends based on timely snapshots generated by a tool such as `zfs-auto-snapshot`.  
It can use local pipes, `SSH`, or `mbuffer` for data transfer. It has modes for nesting datasets on the destination, and special handling for mountpoints of root pools.  
Dataset-specific options are stored as custom properties within the dataset, and datasets to backup are automatically discovered.

It can be automated to run with a backup server which is normally powered off using [offline-zfs-backup](https://github.com/TheUbuntuGuy/offline-zfs-backup).

All configuration options and their explanations can be found in the config file `/etc/furneaux.conf`. All options can be overridden from the command line as well, including specifying other configuration files.

## Quick Usage Reference
```
Usage: furneaux [--simulate] [--ignore-lock] [--config FILE]
  --simulate                Print the commands which would be run,
                            but don't actually execute them.
  --ignore-lock             Ignore the presence of a lock file and run regardless.
                            This option is dangerous and should only be used to
                            clear a previous failure.
  --config FILE             Load a custom configuration file.
                            If not set, defaults to '/etc/furneaux.conf'.

The following options override those set in the configuration file.
See the configuration file for a detailed explanation of each option with examples.
  --snapshot-pattern        The pattern to search for in snapshot names to backup.
  --mode-property           The ZFS property which contains the backup mode.
  --nest-name-property      The ZFS property which contains the dataset name to nest within.
  --zfs-options-property    The ZFS property which contains additional ZFS receive options.
  --remote-pool             The destination pool name.
  --remote-host             The hostname of the destination. Pass "" for the local machine.
  --remote-user             The user to login as on the destination.
  --remote-mode             The transfer mode to a remote system. (ssh/mbuffer)
  --mbuffer-block-size      The block size to set when using mbuffer, or "auto" to use recordsize.
  --mbuffer-port            The port for mbuffer to listen on.
  --mbuffer-buffer-size     The size of the send and receive buffers when using mbuffer.
  --ssh-options             Additional options to pass to SSH.

This script must be run as root.
```

## Sample Output
This is an example of backing up a single dataset using `mbuffer` for transport, and the `root` mode.
```
...
[furneaux] Using mbuffer for transfer
[furneaux]
[furneaux] Processing dataset: rootpool/ROOT/watt
[furneaux] Using mode: root
[furneaux] Nesting in: watt/rootpool/ROOT
[furneaux] Local HEAD is: zfs-auto-snap_daily-2018-02-10-1125
[furneaux] Remote HEAD is: zfs-auto-snap_daily-2018-02-08-1125
[furneaux] Performing send/receive...
[furneaux] Using blocksize: 128k
receiving incremental stream of rootpool/ROOT/watt@zfs-auto-snap_daily-2018-02-09-1125 into backuppool/watt/rootpool/ROOT/watt@zfs-auto-snap_daily-2018-02-09-1125
received 30.1M stream in 30 seconds (1.00M/sec)
receiving incremental stream of rootpool/ROOT/watt@zfs-auto-snap_daily-2018-02-10-1125 into backuppool/watt/rootpool/ROOT/watt@zfs-auto-snap_daily-2018-02-10-1125
received 312B stream in 1 seconds (312B/sec)
[furneaux]
[furneaux] Backup process completed successfully.
```

Another run with a single dataset using `ssh` transport and the `nested` mode.
```
...
[furneaux] Using SSH for transfer
[furneaux] 
[furneaux] Processing dataset: tank/gitlab-data
[furneaux] Using mode: nested
[furneaux] Nesting in: gitlab
[furneaux] Local HEAD is: zfs-auto-snap_daily-2018-02-10-1125
[furneaux] Remote HEAD is: zfs-auto-snap_daily-2018-02-08-1125
[furneaux] Performing send/receive...
receiving incremental stream of tank/gitlab-data@zfs-auto-snap_daily-2018-02-09-1125 into backuppool/gitlab/gitlab-data@zfs-auto-snap_daily-2018-02-09-1125
received 312B stream in 1 seconds (312B/sec)
receiving incremental stream of tank/gitlab-data@zfs-auto-snap_daily-2018-02-10-1125 into backuppool/gitlab/gitlab-data@zfs-auto-snap_daily-2018-02-10-1125
received 312B stream in 1 seconds (312B/sec)
[furneaux] 
[furneaux] Backup process completed successfully.
```

## Installation
Drop furneaux in `/usr/local/bin` to have access to it in your `PATH`.
If you would like to schedule a cron task to automatically attempt a job every X units, drop it into that folder. For example:
```
sudo cp etc/cron.hourly/furneaux-sync /etc/cron.hourly/
```
To adjust how often the script runs, simply change the folder from `cron.hourly` to `cron.X` where `X` is your preferred interval.

## Dependencies
You will need `openssh-client`, `mbuffer`, `zfs-auto-snapshot`, and of course `zfs` installed to use all features. The Debian package links to the related packages.